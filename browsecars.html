<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarRental | Browse Cars</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="browsecars.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase Config -->
    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAgorYlaVB_fk3uCmWQVtM14D2cSlFaBeU",
            authDomain: "carrental-4bdd4.firebaseapp.com",
            projectId: "carrental-4bdd4",
            storageBucket: "carrental-4bdd4.firebasestorage.app",
            messagingSenderId: "318648301485",
            appId: "1:318648301485:web:bc543198901a732b701324",
            measurementId: "G-1C2E4MXEDK"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Initialize Firebase services
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();
    </script>
    
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar - Updated to White -->
        <aside class="sidebar">
            <div class="logo">
                <h2><i class="fas fa-car"></i> CarRental</h2>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="userdashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
                    <li class="active"><a href="browsecars.html"><i class="fas fa-car-side"></i> Browse Cars</a></li>
                    <li><a href="rentalhistory.html"><i class="fas fa-history"></i> Rental History</a></li>
                    <li><a href="reservation.html"><i class="fas fa-calendar-check"></i> Reservation</a></li>
                </ul>
            </nav>
            <!-- Removed sidebar footer with user info and logout button -->
        </aside>

        <!-- Mobile Overlay -->
        <div class="mobile-overlay" id="mobile-overlay"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="nav-left">
                    <button class="burger-menu" id="burger-menu">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    <h1>Browse Cars</h1>
                </div>
                <div class="nav-right">
                    <!-- Removed notification button -->
                </div>
            </header>

            <!-- Browse Cars Content -->
            <div class="content-area">
                <div class="section-header">
                    <h2>Available Cars</h2>
                    <div class="search-filter-container">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="car-search" placeholder="Search by model or brand...">
                        </div>
                        <div class="filter-options">
                            <select id="brand-filter">
                                <option value="">All Brands</option>
                                <option value="Toyota">Toyota</option>
                                <option value="Nissan">Nissan</option>
                                <option value="Mitsubishi">Mitsubishi</option>
                                <option value="Honda">Honda</option>
                                <option value="Ford">Ford</option>
                            </select>
                            <select id="seaters-filter">
                                <option value="">All Seaters</option>
                                <option value="4">4 Seaters</option>
                                <option value="5">5 Seaters</option>
                                <option value="7">7 Seaters</option>
                                <option value="8">8 Seaters</option>
                            </select>
                            <select id="transmission-filter">
                                <option value="">All Transmissions</option>
                                <option value="Automatic">Automatic</option>
                                <option value="Manual">Manual</option>
                                <option value="Automatic/Manual">Automatic/Manual</option>
                            </select>
                            <select id="price-filter">
                                <option value="">Price Range</option>
                                <option value="2000-2500">₱2,000 - ₱2,500</option>
                                <option value="2501-3000">₱2,501 - ₱3,000</option>
                                <option value="3001-3500">₱3,001 - ₱3,500</option>
                                <option value="3501-4000">₱3,501 - ₱4,000</option>
                            </select>
                            <select id="sort-by">
                                <option value="name">Sort by Name</option>
                                <option value="price-low">Price: Low to High</option>
                                <option value="price-high">Price: High to Low</option>
                                <option value="seaters">Seaters: Low to High</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="loading-indicator" id="loading-indicator">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Loading cars...</span>
                </div>

                <div class="cars-grid" id="all-cars-grid">
                    <!-- Cars will be loaded by JavaScript -->
                </div>
            </div>
        </main>
    </div>

    <!-- Reservation Popup -->
    <div class="popup-overlay" id="reservation-popup-overlay">
        <div class="reservation-popup">
            <div class="popup-header">
                <h3>Reserve Car</h3>
                <p>Complete your reservation details</p>
                <button class="popup-close" id="popup-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="popup-body">
                <form id="reservation-form">
                    <div class="form-group">
                        <label for="car-name">Car Name</label>
                        <input type="text" id="car-name" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="daily-price">Daily Price</label>
                        <input type="text" id="daily-price" class="form-control" readonly>
                    </div>
                    <div class="calculation-row">
                        <div class="form-group">
                            <label for="start-date">Start Date</label>
                            <input type="date" id="start-date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="end-date">End Date</label>
                            <input type="date" id="end-date" class="form-control" required>
                        </div>
                    </div>
                    <div class="calculation-row">
                        <div class="form-group">
                            <label for="total-days">Total Days</label>
                            <input type="text" id="total-days" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label for="total-price">Total Price</label>
                            <input type="text" id="total-price" class="form-control" readonly>
                        </div>
                    </div>
                    
                    <!-- Payment Method Selection -->
                    <div class="form-group">
                        <label for="payment-method">Payment Method</label>
                        <select id="payment-method" class="form-control" required>
                            <option value="">Select Payment Method</option>
                            <option value="gcash">GCash</option>
                            <option value="onhand">Pay on Hand</option>
                        </select>
                    </div>
                    
                    <!-- Proof of Payment Section (Only for GCash) -->
                    <div id="proof-of-payment-section" style="display: none;">
                        <div class="form-group">
                            <label for="proof-of-payment">Proof of Payment (GCash Screenshot)</label>
                            <input type="file" id="proof-of-payment" class="form-control" accept="image/*">
                            <small class="form-text">Please upload a screenshot of your GCash payment confirmation</small>
                        </div>
                    </div>
                    
                    <div class="popup-footer">
                        <button type="button" class="btn btn-secondary" id="cancel-reservation">Cancel</button>
                        <button type="submit" class="btn btn-primary">Confirm Reservation</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message">Reservation successful!</span>
    </div>

    <style>
        .no-cars-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .no-cars-message i {
            margin-bottom: 20px;
            color: #ccc;
        }
        
        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            grid-column: 1 / -1;
        }
        
        .form-text {
            color: #666;
            font-size: 0.85rem;
            margin-top: 5px;
        }
    </style>

    <script>
        // Burger menu functionality
        const burgerMenu = document.getElementById('burger-menu');
        const sidebar = document.querySelector('.sidebar');
        const mobileOverlay = document.getElementById('mobile-overlay');

        if (burgerMenu && sidebar && mobileOverlay) {
            burgerMenu.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                burgerMenu.classList.toggle('active');
                mobileOverlay.classList.toggle('active');
            });

            mobileOverlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                burgerMenu.classList.remove('active');
                mobileOverlay.classList.remove('active');
            });
        }

        // Firebase integration for Browse Cars
        class BrowseCars {
            constructor() {
                this.cars = [];
                this.currentUser = null;
                this.init();
            }

            async init() {
                await this.checkAuth();
                this.setupEventListeners();
                await this.loadCarsFromFirebase();
                this.initializeReservationPopup();
            }

            async checkAuth() {
                return new Promise((resolve) => {
                    auth.onAuthStateChanged((user) => {
                        if (user) {
                            this.currentUser = user;
                            console.log('User authenticated:', user.email);
                            resolve(user);
                        } else {
                            console.log('User not authenticated - using guest mode');
                            resolve(null);
                        }
                    });
                });
            }

            setupEventListeners() {
                // Removed logout button event listener
            }

            async loadCarsFromFirebase() {
                const loadingIndicator = document.getElementById('loading-indicator');
                const carsGrid = document.getElementById('all-cars-grid');
                
                try {
                    loadingIndicator.style.display = 'flex';
                    carsGrid.style.display = 'none';

                    console.log("Loading cars from Firebase...");
                    
                    const allCarsSnapshot = await db.collection('cars')
                        .where('available', '==', true)
                        .where('status', '==', 'Available')
                        .get();
                    
                    console.log("Total cars in database:", allCarsSnapshot.size);
                    
                    this.cars = [];
                    allCarsSnapshot.forEach(doc => {
                        const car = doc.data();
                        car.id = doc.id;
                        console.log("Car found:", car);
                        
                        // Ensure all required fields are present with proper fallbacks
                        if (!car.name && car.model) car.name = car.model;
                        if (!car.brand && car.type) car.brand = car.type;
                        if (!car.transmission) car.transmission = 'Automatic';
                        if (!car.description) car.description = `${car.name} - A comfortable and reliable vehicle for your travel needs.`;
                        if (!car.seaters && car.seater) car.seaters = car.seater;
                        
                        // Handle image fields - check all possible image fields from admin
                        if (!car.mainImage && car.imageBase64) {
                            car.mainImage = car.imageBase64; // Use base64 image if available
                        }
                        
                        this.cars.push(car);
                    });

                    console.log(`Found ${this.cars.length} available cars in Firebase`);

                    if (this.cars.length === 0) {
                        console.log('No available cars found in Firebase');
                        this.showNoCarsMessage();
                    } else {
                        this.renderCars(this.cars);
                        this.setupFilters();
                    }

                } catch (error) {
                    console.error('Error loading cars from Firebase:', error);
                    this.showNoCarsMessage();
                } finally {
                    loadingIndicator.style.display = 'none';
                    carsGrid.style.display = 'grid';
                }
            }

            showNoCarsMessage() {
                const allCarsGrid = document.getElementById('all-cars-grid');
                allCarsGrid.innerHTML = `
                    <div class="no-cars-message">
                        <i class="fas fa-car fa-3x"></i>
                        <h3>No Cars Available</h3>
                        <p>There are no cars available for rent at the moment. Please check back later.</p>
                    </div>
                `;
            }

            setupFilters() {
                const searchInput = document.getElementById('car-search');
                const brandFilter = document.getElementById('brand-filter');
                const seatersFilter = document.getElementById('seaters-filter');
                const transmissionFilter = document.getElementById('transmission-filter');
                const priceFilter = document.getElementById('price-filter');
                const sortBy = document.getElementById('sort-by');

                if (searchInput) searchInput.addEventListener('input', () => this.filterCars());
                if (brandFilter) brandFilter.addEventListener('change', () => this.filterCars());
                if (seatersFilter) seatersFilter.addEventListener('change', () => this.filterCars());
                if (transmissionFilter) transmissionFilter.addEventListener('change', () => this.filterCars());
                if (priceFilter) priceFilter.addEventListener('change', () => this.filterCars());
                if (sortBy) sortBy.addEventListener('change', () => this.filterCars());
            }

            filterCars() {
                const searchInput = document.getElementById('car-search');
                const brandFilter = document.getElementById('brand-filter');
                const seatersFilter = document.getElementById('seaters-filter');
                const transmissionFilter = document.getElementById('transmission-filter');
                const priceFilter = document.getElementById('price-filter');
                const sortBy = document.getElementById('sort-by');

                const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                const brandValue = brandFilter ? brandFilter.value : '';
                const seatersValue = seatersFilter ? seatersFilter.value : '';
                const transmissionValue = transmissionFilter ? transmissionFilter.value : '';
                const priceValue = priceFilter ? priceFilter.value : '';
                const sortValue = sortBy ? sortBy.value : 'name';

                let filteredCars = this.cars.filter(car => {
                    const matchesSearch = car.name.toLowerCase().includes(searchTerm) || 
                                        (car.brand && car.brand.toLowerCase().includes(searchTerm)) ||
                                        car.description.toLowerCase().includes(searchTerm);
                    
                    const matchesBrand = !brandValue || (car.brand && car.brand === brandValue);
                    const matchesSeaters = !seatersValue || (car.seaters && car.seaters == seatersValue) || (car.seater && car.seater == seatersValue);
                    const matchesTransmission = !transmissionValue || car.transmission === transmissionValue;
                    
                    let matchesPrice = true;
                    if (priceValue) {
                        const [min, max] = priceValue.split('-').map(Number);
                        if (max) {
                            matchesPrice = car.price >= min && car.price <= max;
                        } else {
                            matchesPrice = car.price >= min;
                        }
                    }
                    
                    return matchesSearch && matchesBrand && matchesSeaters && matchesTransmission && matchesPrice;
                });

                // Sort cars
                switch(sortValue) {
                    case 'price-low':
                        filteredCars.sort((a, b) => a.price - b.price);
                        break;
                    case 'price-high':
                        filteredCars.sort((a, b) => b.price - a.price);
                        break;
                    case 'seaters':
                        filteredCars.sort((a, b) => (a.seaters || a.seater) - (b.seaters || b.seater));
                        break;
                    case 'name':
                    default:
                        filteredCars.sort((a, b) => a.name.localeCompare(b.name));
                        break;
                }

                this.renderCars(filteredCars);
            }

            renderCars(carsToRender) {
                const allCarsGrid = document.getElementById('all-cars-grid');
                if (!allCarsGrid) return;

                allCarsGrid.innerHTML = '';

                if (carsToRender.length === 0) {
                    allCarsGrid.innerHTML = '<p class="no-results">No cars match your search criteria. Please try different filters.</p>';
                    return;
                }

                carsToRender.forEach(car => {
                    const carCard = this.createCarCard(car);
                    allCarsGrid.appendChild(carCard);
                });
            }

            createCarCard(car) {
                const carCard = document.createElement('div');
                carCard.className = 'car-card';

                // Car image with improved image handling
                const carImage = document.createElement('div');
                carImage.className = 'car-image';
                
                const img = document.createElement('img');
                
                // Enhanced image source handling - check all possible image fields
                if (car.mainImage) {
                    // If mainImage is a base64 string (starts with data:image)
                    if (car.mainImage.startsWith('data:image')) {
                        img.src = car.mainImage;
                    } else {
                        // If it's a URL
                        img.src = car.mainImage;
                    }
                } else if (car.imageBase64) {
                    // Fallback to imageBase64 field
                    img.src = car.imageBase64;
                } else if (car.image) {
                    // Fallback to image field
                    img.src = car.image;
                } else if (car.imageUrls && car.imageUrls.length > 0) {
                    // Fallback to imageUrls array
                    img.src = car.imageUrls[0];
                } else {
                    // Final fallback to placeholder
                    img.src = 'https://images.unsplash.com/photo-1549317661-bd32c8ce0db2?ixlib=rb-4.0.3&auto=format&fit=crop&w=1170&q=80';
                }
                
                img.alt = car.name;
                img.onerror = function() {
                    console.log('Image failed to load, using fallback');
                    this.src = 'https://images.unsplash.com/photo-1549317661-bd32c8ce0db2?ixlib=rb-4.0.3&auto=format&fit=crop&w=1170&q=80';
                };
                carImage.appendChild(img);

                // Car details
                const carDetails = document.createElement('div');
                carDetails.className = 'car-details';

                const carTitle = document.createElement('h3');
                carTitle.textContent = car.name;
                carDetails.appendChild(carTitle);

                const carSpecs = document.createElement('div');
                carSpecs.className = 'car-specs';

                const seaters = car.seaters || car.seater;
                const seatersSpan = document.createElement('span');
                seatersSpan.innerHTML = `<i class="fas fa-users"></i> ${seaters} Seater${seaters > 1 ? 's' : ''}`;

                const transmissionSpan = document.createElement('span');
                transmissionSpan.innerHTML = `<i class="fas fa-cog"></i> ${car.transmission || 'Automatic'}`;

                const brandSpan = document.createElement('span');
                brandSpan.innerHTML = `<i class="fas fa-tag"></i> ${car.brand || car.type || 'Car'}`;

                carSpecs.appendChild(seatersSpan);
                carSpecs.appendChild(transmissionSpan);
                carSpecs.appendChild(brandSpan);
                carDetails.appendChild(carSpecs);

                const carDescription = document.createElement('p');
                carDescription.className = 'car-description';
                carDescription.textContent = car.description || `${car.name} - A comfortable and reliable vehicle for your travel needs.`;
                carDetails.appendChild(carDescription);

                const carFooter = document.createElement('div');
                carFooter.className = 'car-footer';

                const priceDiv = document.createElement('div');
                priceDiv.className = 'price';

                const amountSpan = document.createElement('span');
                amountSpan.className = 'amount';
                amountSpan.textContent = `₱${car.price.toLocaleString()}`;

                const periodSpan = document.createElement('span');
                periodSpan.className = 'period';
                periodSpan.textContent = '/day';

                priceDiv.appendChild(amountSpan);
                priceDiv.appendChild(periodSpan);
                carFooter.appendChild(priceDiv);

                // Rent Now button
                const rentBtn = document.createElement('button');
                rentBtn.className = 'rent-btn';
                rentBtn.textContent = 'Rent Now';
                rentBtn.addEventListener('click', () => {
                    window.openReservationPopup(car);
                });

                carFooter.appendChild(rentBtn);
                carDetails.appendChild(carFooter);
                carCard.appendChild(carImage);
                carCard.appendChild(carDetails);

                return carCard;
            }

            initializeReservationPopup() {
                const popupOverlay = document.getElementById('reservation-popup-overlay');
                const popupClose = document.getElementById('popup-close');
                const cancelBtn = document.getElementById('cancel-reservation');
                const reservationForm = document.getElementById('reservation-form');
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toast-message');
                const paymentMethodSelect = document.getElementById('payment-method');
                const proofOfPaymentSection = document.getElementById('proof-of-payment-section');

                const carNameInput = document.getElementById('car-name');
                const dailyPriceInput = document.getElementById('daily-price');
                const startDateInput = document.getElementById('start-date');
                const endDateInput = document.getElementById('end-date');
                const totalDaysInput = document.getElementById('total-days');
                const totalPriceInput = document.getElementById('total-price');

                let selectedCar = null;

                window.openReservationPopup = (car) => {
                    selectedCar = car;
                    carNameInput.value = car.name;
                    dailyPriceInput.value = `₱${car.price.toLocaleString()}`;
                    
                    // Reset form
                    startDateInput.value = '';
                    endDateInput.value = '';
                    totalDaysInput.value = '';
                    totalPriceInput.value = '';
                    paymentMethodSelect.value = '';
                    proofOfPaymentSection.style.display = 'none';
                    document.getElementById('proof-of-payment').value = '';
                    
                    // Show popup
                    popupOverlay.classList.add('active');
                    
                    // Set minimum date to today
                    const today = new Date().toISOString().split('T')[0];
                    startDateInput.min = today;
                    endDateInput.min = today;
                };

                const closePopup = () => {
                    popupOverlay.classList.remove('active');
                    selectedCar = null;
                };

                popupClose.addEventListener('click', closePopup);
                cancelBtn.addEventListener('click', closePopup);

                // Show/hide proof of payment section based on payment method
                paymentMethodSelect.addEventListener('change', function() {
                    if (this.value === 'gcash') {
                        proofOfPaymentSection.style.display = 'block';
                    } else {
                        proofOfPaymentSection.style.display = 'none';
                    }
                });

                // Calculate total days and price when dates change
                const calculateTotal = () => {
                    if (startDateInput.value && endDateInput.value) {
                        const startDate = new Date(startDateInput.value);
                        const endDate = new Date(endDateInput.value);
                        
                        // Check if end date is after start date
                        if (endDate <= startDate) {
                            alert('End date must be after start date');
                            endDateInput.value = '';
                            totalDaysInput.value = '';
                            totalPriceInput.value = '';
                            return;
                        }
                        
                        // Calculate days difference
                        const timeDiff = endDate.getTime() - startDate.getTime();
                        const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                        
                        // Update form
                        totalDaysInput.value = `${daysDiff} day${daysDiff > 1 ? 's' : ''}`;
                        totalPriceInput.value = `₱${(selectedCar.price * daysDiff).toLocaleString()}`;
                    }
                };

                startDateInput.addEventListener('change', calculateTotal);
                endDateInput.addEventListener('change', calculateTotal);

                // Handle form submission
                reservationForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    // Validate form
                    if (!startDateInput.value || !endDateInput.value) {
                        alert('Please select both start and end dates');
                        return;
                    }

                    if (!paymentMethodSelect.value) {
                        alert('Please select a payment method');
                        return;
                    }

                    // Validate proof of payment for GCash
                    const proofOfPaymentInput = document.getElementById('proof-of-payment');
                    if (paymentMethodSelect.value === 'gcash' && !proofOfPaymentInput.files[0]) {
                        alert('Please upload proof of payment for GCash payment');
                        return;
                    }
                    
                    if (!this.currentUser) {
                        alert('Please log in to make a reservation');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    // Calculate days
                    const startDate = new Date(startDateInput.value);
                    const endDate = new Date(endDateInput.value);
                    const timeDiff = endDate.getTime() - startDate.getTime();
                    const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                    const totalPrice = selectedCar.price * daysDiff;
                    
                    try {
                        // Handle proof of payment upload if GCash - USING BASE64 NOW
                        let proofOfPaymentBase64 = null;
                        if (paymentMethodSelect.value === 'gcash' && proofOfPaymentInput.files[0]) {
                            proofOfPaymentBase64 = await this.convertImageToBase64(proofOfPaymentInput.files[0]);
                        }

                        // Save reservation to Firestore with proper structure
                        const reservationData = {
                            userId: this.currentUser.uid,
                            carId: selectedCar.id,
                            carName: selectedCar.name,
                            startDate: firebase.firestore.Timestamp.fromDate(startDate),
                            endDate: firebase.firestore.Timestamp.fromDate(endDate),
                            totalDays: daysDiff,
                            totalPrice: totalPrice,
                            paymentMethod: paymentMethodSelect.value,
                            paymentStatus: paymentMethodSelect.value === 'onhand' ? 'pending' : 'paid',
                            status: 'pending',
                            adminStatus: 'pending',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        // Add proof of payment as base64 if available
                        if (proofOfPaymentBase64) {
                            reservationData.proofOfPaymentBase64 = proofOfPaymentBase64;
                            reservationData.hasProofOfPayment = true;
                        }

                        await db.collection('reservations').add(reservationData);
                        
                        // Show success message
                        toastMessage.textContent = `Reservation successful! Your booking for ${selectedCar.name} has been added.`;
                        toast.classList.add('active');
                        
                        // Close popup after delay
                        setTimeout(() => {
                            closePopup();
                            setTimeout(() => {
                                toast.classList.remove('active');
                            }, 3000);
                        }, 1500);
                        
                    } catch (error) {
                        console.error('Error saving reservation:', error);
                        alert('Failed to save reservation. Please try again.');
                    }
                });

                // Add this new method to convert image to base64
                this.convertImageToBase64 = (file) => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => {
                            // Resize and compress the image before converting to base64
                            this.compressImage(reader.result, 800, 0.7)
                                .then(compressedBase64 => {
                                    resolve(compressedBase64);
                                })
                                .catch(error => {
                                    console.error('Error compressing image:', error);
                                    // If compression fails, use the original base64
                                    resolve(reader.result);
                                });
                        };
                        reader.onerror = error => reject(error);
                        reader.readAsDataURL(file);
                    });
                };

                // Add this method to compress images (optional but recommended)
                this.compressImage = (base64Str, maxWidth = 800, quality = 0.7) => {
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.src = base64Str;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = maxWidth;
                            const MAX_HEIGHT = MAX_WIDTH * (img.height / img.width);
                            
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > MAX_WIDTH) {
                                    height *= MAX_WIDTH / width;
                                    width = MAX_WIDTH;
                                }
                            } else {
                                if (height > MAX_WIDTH) {
                                    width *= MAX_WIDTH / height;
                                    height = MAX_WIDTH;
                                }
                            }

                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Convert to base64 with specified quality
                            resolve(canvas.toDataURL('image/jpeg', quality));
                        };
                    });
                };

                // Close popup when clicking outside
                popupOverlay.addEventListener('click', (e) => {
                    if (e.target === popupOverlay) {
                        closePopup();
                    }
                });
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new BrowseCars();
        });
    </script>
</body>
</html>