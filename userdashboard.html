<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarRental | Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="userdashboard.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Config -->
    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAgorYlaVB_fk3uCmWQVtM14D2cSlFaBeU",
            authDomain: "carrental-4bdd4.firebaseapp.com",
            projectId: "carrental-4bdd4",
            storageBucket: "carrental-4bdd4.firebasestorage.app",
            messagingSenderId: "318648301485",
            appId: "1:318648301485:web:bc543198901a732b701324",
            measurementId: "G-1C2E4MXEDK"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>


</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <h2><i class="fas fa-car"></i> Lakbay Rent</h2>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li class="active"><a href="userdashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
                    <li><a href="browsecars.html"><i class="fas fa-car-side"></i> Browse Cars</a></li>
                    <li><a href="rentalhistory.html"><i class="fas fa-history"></i> Rental History</a></li>
                    <li><a href="reservation.html"><i class="fas fa-calendar-check"></i> Reservation</a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="user-details">
                        <h4 id="sidebar-username">Loading...</h4>
                        <p>Premium Member</p>
                    </div>
                </div>
                <button class="logout-btn" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Mobile Overlay -->
        <div class="mobile-overlay" id="mobile-overlay"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="nav-left">
                    <button class="burger-menu" id="burger-menu">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    <h1>Dashboard</h1>
                 </div>

                <div class="nav-right">
                    <div class="user-profile" onclick="window.location.href='userprofile.html'">
                        <div class="avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                         <span id="topnav-username">Loading...</span>
                    </div>
                </div>
            </header>

            <!-- Dashboard Content -->
            <div class="content-area">
                <!-- Welcome Section -->
                <section class="welcome-section">
                    <div class="welcome-card">
                        <h2 id="welcome-message">Welcome Back!</h2>
                        <p>Ready to find your next rental car? Check out our latest deals and available vehicles.</p>
                        <a href="browsecars.html" class="cta-button">Browse Available Cars</a>
                    </div>
                    <div class="stats-card">
                        <div class="stat">
                            <h3 id="total-rentals">0</h3>
                            <p>Total Rentals</p>
                        </div>
                        <div class="stat">
                            <h3 id="active-rentals">0</h3>
                            <p>Active Rental</p>
                        </div>
                        <div class="stat">
                            <h3 id="total-spent">₱0</h3>
                            <p>Total Spent</p>
                        </div>
                    </div>
                </section>

                <!-- Available Cars Section -->
                <section class="cars-section">
                    <div class="section-header">
                        <h2>Featured Cars</h2>
                        <a href="browsecars.html" class="cta-button">View All Cars</a>
                    </div>

                    <div class="cars-grid" id="cars-grid">
                        <!-- Cars will be loaded dynamically from Firebase -->
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </section>

                <!-- Account Section -->
                <div class="account-card">
                    <div class="card-header">
                        <h3>Account Information</h3>
                        <button class="edit-btn" onclick="window.location.href='userprofile.html'"><i class="fas fa-edit"></i> Edit Profile</button>
                    </div>
                    <div class="account-details">
                        <div class="detail-item">
                            <label>Full Name</label>
                            <p id="account-fullname">Loading...</p>
                        </div>
                        <div class="detail-item">
                            <label>Email Address</label>
                            <p id="account-email">Loading...</p>
                        </div>
                        <div class="detail-item">
                            <label>Phone Number</label>
                            <p id="account-phone">Loading...</p>
                        </div>
                        <div class="detail-item">
                            <label>License Verified</label>
                            <p class="membership-badge">Verified</p>
                        </div>
                        <div class="detail-item">
                            <label>Membership Status</label>
                            <p class="membership-badge">Premium Member</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Reservation Popup - UPDATED TO MATCH BROWSE CARS -->
    <div class="popup-overlay" id="reservation-popup-overlay">
        <div class="reservation-popup">
            <div class="popup-header">
                <h3>Reserve Car</h3>
                <p>Complete your reservation details</p>
                <button class="popup-close" id="popup-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="popup-body">
                <form id="reservation-form">
                    <div class="form-group">
                        <label for="car-name">Car Name</label>
                        <input type="text" id="car-name" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="daily-price">Daily Price</label>
                        <input type="text" id="daily-price" class="form-control" readonly>
                    </div>
                    <div class="calculation-row">
                        <div class="form-group">
                            <label for="start-date">Start Date</label>
                            <input type="date" id="start-date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="end-date">End Date</label>
                            <input type="date" id="end-date" class="form-control" required>
                        </div>
                    </div>
                    <div class="calculation-row">
                        <div class="form-group">
                            <label for="total-days">Total Days</label>
                            <input type="text" id="total-days" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label for="total-price">Total Price</label>
                            <input type="text" id="total-price" class="form-control" readonly>
                        </div>
                    </div>
                    
                    <!-- Payment Method Selection - ADDED FROM BROWSE CARS -->
                    <div class="form-group">
                        <label for="payment-method">Payment Method</label>
                        <select id="payment-method" class="form-control" required>
                            <option value="">Select Payment Method</option>
                            <option value="gcash">GCash</option>
                            <option value="onhand">Pay on Hand</option>
                        </select>
                    </div>
                    
                    <!-- Proof of Payment Section (Only for GCash) - ADDED FROM BROWSE CARS -->
                    <div id="proof-of-payment-section" style="display: none;">
                        <div class="form-group">
                            <label for="proof-of-payment">Proof of Payment (GCash Screenshot)</label>
                            <input type="file" id="proof-of-payment" class="form-control" accept="image/*">
                            <small class="form-text">Please upload a screenshot of your GCash payment confirmation</small>
                        </div>
                    </div>
                    
                    <div class="popup-footer">
                        <button type="button" class="btn btn-secondary" id="cancel-reservation">Cancel</button>
                        <button type="submit" class="btn btn-primary">Confirm Reservation</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message">Reservation successful!</span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const burgerMenu = document.getElementById('burger-menu');
            const sidebar = document.querySelector('.sidebar');
            const mobileOverlay = document.getElementById('mobile-overlay');
            const logoutBtn = document.getElementById('logout-btn');
            const popupOverlay = document.getElementById('reservation-popup-overlay');
            const popupClose = document.getElementById('popup-close');
            const cancelBtn = document.getElementById('cancel-reservation');
            const reservationForm = document.getElementById('reservation-form');
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const paymentMethodSelect = document.getElementById('payment-method');
            const proofOfPaymentSection = document.getElementById('proof-of-payment-section');
            
            // User info elements
            const sidebarUsername = document.getElementById('sidebar-username');
            const topnavUsername = document.getElementById('topnav-username');
            const welcomeMessage = document.getElementById('welcome-message');
            const accountFullname = document.getElementById('account-fullname');
            const accountEmail = document.getElementById('account-email');
            const accountPhone = document.getElementById('account-phone');
            
            // Stats elements
            const totalRentalsElement = document.getElementById('total-rentals');
            const activeRentalsElement = document.getElementById('active-rentals');
            const totalSpentElement = document.getElementById('total-spent');
            
            // Form elements
            const carNameInput = document.getElementById('car-name');
            const dailyPriceInput = document.getElementById('daily-price');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const totalDaysInput = document.getElementById('total-days');
            const totalPriceInput = document.getElementById('total-price');
            const proofOfPaymentInput = document.getElementById('proof-of-payment');
            
            // Current selected car data
            let selectedCar = null;
            let currentUser = null;
            let userUnsubscribe = null;
            let carsUnsubscribe = null;
            let reservationsUnsubscribe = null;
            
            // Burger menu functionality
            function toggleMenu() {
                sidebar.classList.toggle('active');
                burgerMenu.classList.toggle('active');
                mobileOverlay.classList.toggle('active');
            }
            
            // Close menu when clicking on overlay
            mobileOverlay.addEventListener('click', toggleMenu);
            
            // Toggle menu when burger icon is clicked
            burgerMenu.addEventListener('click', toggleMenu);
            
            // Close menu when clicking on a sidebar link
            const sidebarLinks = document.querySelectorAll('.sidebar-nav a');
            sidebarLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 992) {
                        toggleMenu();
                    }
                });
            });
            
            // Check if user is logged in
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    console.log('User logged in:', user.email);
                    
                    // Set up real-time listener for user data
                    setupUserDataListener(user.uid);
                    
                    // Update UI with user info
                    updateUserInfo(user);
                    
                    // Set up real-time listener for cars
                    setupCarsListener();
                    
                    // Set up real-time listener for user's reservations
                    setupReservationsListener(user.uid);
                } else {
                    // Redirect to login if not authenticated
                    window.location.href = 'login.html';
                }
            });
            
            // Set up real-time listener for user data
            function setupUserDataListener(userId) {
                // Unsubscribe from previous listener if exists
                if (userUnsubscribe) {
                    userUnsubscribe();
                }
                
                // Set up real-time listener for user document
                userUnsubscribe = db.collection('users').doc(userId)
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const userData = doc.data();
                            console.log('User data updated:', userData);
                            
                            // Update account information
                            if (userData.fullName) {
                                accountFullname.textContent = userData.fullName;
                            }
                            if (userData.email) {
                                accountEmail.textContent = userData.email;
                            }
                            if (userData.contactNumber) {
                                accountPhone.textContent = userData.contactNumber;
                            }
                            
                            // Update username in sidebar and top navigation
                            if (userData.fullName) {
                                const username = userData.fullName.split(' ')[0];
                                sidebarUsername.textContent = username;
                                topnavUsername.textContent = username;
                                welcomeMessage.textContent = `Welcome Back, ${username}!`;
                            }
                        } else {
                            console.log('No user data found in Firestore');
                            // Use auth data as fallback
                            updateUserInfo(currentUser);
                        }
                    }, (error) => {
                        console.error('Error listening to user data:', error);
                        // Use auth data as fallback
                        updateUserInfo(currentUser);
                    });
            }
            
            // Set up real-time listener for user's reservations
            function setupReservationsListener(userId) {
                // Unsubscribe from previous listener if exists
                if (reservationsUnsubscribe) {
                    reservationsUnsubscribe();
                }
                
                // Set up real-time listener for user's reservations
                reservationsUnsubscribe = db.collection('reservations')
                    .where('userId', '==', userId)
                    .onSnapshot((querySnapshot) => {
                        console.log('Reservations data updated');
                        calculateUserStats(querySnapshot);
                    }, (error) => {
                        console.error('Error listening to reservations data:', error);
                    });
            }
            
            // Calculate user statistics from reservations
            function calculateUserStats(querySnapshot) {
                let totalRentals = 0;
                let activeRentals = 0;
                let totalSpent = 0;
                
                if (!querySnapshot.empty) {
                    querySnapshot.forEach((doc) => {
                        const reservation = doc.data();
                        totalRentals++;
                        
                        // Check if reservation is active (approved and within date range)
                        if (reservation.adminStatus === 'approved') {
                            const now = new Date();
                            const startDate = reservation.startDate.toDate ? reservation.startDate.toDate() : new Date(reservation.startDate);
                            const endDate = reservation.endDate.toDate ? reservation.endDate.toDate() : new Date(reservation.endDate);
                            
                            if (now >= startDate && now <= endDate) {
                                activeRentals++;
                            }
                        }
                        
                        // Add to total spent if reservation is paid or completed
                        if (reservation.paymentStatus === 'paid' || reservation.adminStatus === 'approved') {
                            totalSpent += reservation.totalPrice || 0;
                        }
                    });
                }
                
                // Update the UI with calculated stats
                totalRentalsElement.textContent = totalRentals;
                activeRentalsElement.textContent = activeRentals;
                totalSpentElement.textContent = `₱${totalSpent.toLocaleString()}`;
            }
            
            // Set up real-time listener for cars - UPDATED TO FILTER MAINTENANCE CARS
            function setupCarsListener() {
                // Unsubscribe from previous listener if exists
                if (carsUnsubscribe) {
                    carsUnsubscribe();
                }
                
                // Set up real-time listener for cars collection
                // Filter cars that are available AND status is "Available" (not maintenance)
                carsUnsubscribe = db.collection('cars')
                    .where('available', '==', true)
                    .where('status', '==', 'Available') // Only show cars with status "Available"
                    .limit(6) // Limit to 6 featured cars
                    .onSnapshot((querySnapshot) => {
                        console.log('Cars data updated - maintenance cars filtered out');
                        loadCarsFromSnapshot(querySnapshot);
                    }, (error) => {
                        console.error('Error listening to cars data:', error);
                        const carsGrid = document.getElementById('cars-grid');
                        carsGrid.innerHTML = '<p>Error loading cars. Please try again later.</p>';
                    });
            }
            
            // Load cars from Firestore snapshot
            function loadCarsFromSnapshot(querySnapshot) {
                const carsGrid = document.getElementById('cars-grid');
                
                if (querySnapshot.empty) {
                    carsGrid.innerHTML = '<p>No cars available at the moment.</p>';
                    return;
                }
                
                carsGrid.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    const car = doc.data();
                    const carId = doc.id;
                    
                    // Use price field instead of dailyPrice
                    const carPrice = car.price || car.dailyPrice || 0;
                    
                    // Create car card
                    const carCard = document.createElement('div');
                    carCard.className = 'car-card';
                    
                    // Determine badge class based on category
                    let badgeClass = '';
                    if (car.category === 'Premium') badgeClass = 'premium';
                    if (car.category === 'Adventure/Luxury') badgeClass = 'adventure';
                    
                    carCard.innerHTML = `
                        <div class="car-image">
                            <img src="${car.image || car.mainImage || car.imageUrls?.[0] || 'https://images.unsplash.com/photo-1549317661-bd32c8ce0db2?ixlib=rb-4.0.3&auto=format&fit=crop&w=1170&q=80'}" alt="${car.name}" onerror="this.src='https://images.unsplash.com/photo-1549317661-bd32c8ce0db2?ixlib=rb-4.0.3&auto=format&fit=crop&w=1170&q=80'">
                            <div class="car-badge ${badgeClass}">${car.category || 'Economy'}</div>
                        </div>
                        <div class="car-details">
                            <h3>${car.name}</h3>
                            <div class="car-specs">
                                <span><i class="fas fa-users"></i> ${car.seaters || car.seater || '5'} Seaters</span>
                                <span><i class="fas fa-cog"></i> ${car.transmission || 'Automatic'}</span>
                            </div>
                            <p class="car-description">${car.description || 'A reliable vehicle for your travel needs.'}</p>
                            <div class="car-footer">
                                <div class="price">
                                    <span class="amount">₱${carPrice.toLocaleString()}</span>
                                    <span class="period">/day</span>
                                </div>
                                <button class="rent-btn" data-car-id="${carId}" data-car-name="${car.name}" data-daily-price="${carPrice}">Rent Now</button>
                            </div>
                        </div>
                    `;
                    
                    carsGrid.appendChild(carCard);
                });
                
                // Add event listeners to Rent Now buttons
                const rentButtons = document.querySelectorAll('.rent-btn');
                rentButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const carId = this.getAttribute('data-car-id');
                        const carName = this.getAttribute('data-car-name');
                        const dailyPrice = parseInt(this.getAttribute('data-daily-price'));
                        
                        // Create car object with the data from the button
                        const car = {
                            id: carId,
                            name: carName,
                            price: dailyPrice
                        };
                        
                        // Open reservation popup
                        openReservationPopup(car);
                    });
                });
            }
            
            // Update user information in the UI
            function updateUserInfo(user) {
                const displayName = user.displayName || user.email.split('@')[0];
                
                // Update username in sidebar
                sidebarUsername.textContent = displayName;
                
                // Update username in top navigation
                topnavUsername.textContent = displayName;
                
                // Update welcome message
                welcomeMessage.textContent = `Welcome Back, ${displayName}!`;
            }
            
            // Open popup function - UPDATED TO RESET PAYMENT FIELDS
            function openReservationPopup(car) {
                selectedCar = car;
                
                // Set form values
                carNameInput.value = car.name;
                dailyPriceInput.value = `₱${car.price.toLocaleString()}`;
                
                // Reset form
                startDateInput.value = '';
                endDateInput.value = '';
                totalDaysInput.value = '';
                totalPriceInput.value = '';
                paymentMethodSelect.value = '';
                proofOfPaymentSection.style.display = 'none';
                proofOfPaymentInput.value = '';
                
                // Show popup
                popupOverlay.classList.add('active');
                
                // Set minimum date to today
                const today = new Date().toISOString().split('T')[0];
                startDateInput.min = today;
                endDateInput.min = today;
            }
            
            // Close popup
            function closePopup() {
                popupOverlay.classList.remove('active');
                selectedCar = null;
            }
            
            // Event listeners for closing popup
            popupClose.addEventListener('click', closePopup);
            cancelBtn.addEventListener('click', closePopup);
            
            // Show/hide proof of payment section based on payment method - ADDED FROM BROWSE CARS
            paymentMethodSelect.addEventListener('change', function() {
                if (this.value === 'gcash') {
                    proofOfPaymentSection.style.display = 'block';
                } else {
                    proofOfPaymentSection.style.display = 'none';
                }
            });
            
            // Calculate total days and price when dates change
            startDateInput.addEventListener('change', calculateTotal);
            endDateInput.addEventListener('change', calculateTotal);
            
            function calculateTotal() {
                if (startDateInput.value && endDateInput.value) {
                    const startDate = new Date(startDateInput.value);
                    const endDate = new Date(endDateInput.value);
                    
                    // Check if end date is after start date
                    if (endDate <= startDate) {
                        alert('End date must be after start date');
                        endDateInput.value = '';
                        totalDaysInput.value = '';
                        totalPriceInput.value = '';
                        return;
                    }
                    
                    // Calculate days difference
                    const timeDiff = endDate.getTime() - startDate.getTime();
                    const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                    
                    // Update form
                    totalDaysInput.value = `${daysDiff} day${daysDiff > 1 ? 's' : ''}`;
                    totalPriceInput.value = `₱${(selectedCar.price * daysDiff).toLocaleString()}`;
                }
            }
            
            // Handle form submission - UPDATED TO MATCH BROWSE CARS FUNCTIONALITY
            reservationForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Validate form
                if (!startDateInput.value || !endDateInput.value) {
                    alert('Please select both start and end dates');
                    return;
                }

                if (!paymentMethodSelect.value) {
                    alert('Please select a payment method');
                    return;
                }

                // Validate proof of payment for GCash
                if (paymentMethodSelect.value === 'gcash' && !proofOfPaymentInput.files[0]) {
                    alert('Please upload proof of payment for GCash payment');
                    return;
                }
                
                // Calculate days
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);
                const timeDiff = endDate.getTime() - startDate.getTime();
                const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                const totalPrice = selectedCar.price * daysDiff;
                
                try {
                    // Handle proof of payment upload if GCash
                    let proofOfPaymentBase64 = null;
                    if (paymentMethodSelect.value === 'gcash' && proofOfPaymentInput.files[0]) {
                        proofOfPaymentBase64 = await convertImageToBase64(proofOfPaymentInput.files[0]);
                    }

                    // Save reservation to Firestore with proper structure
                    const reservationData = {
                        userId: currentUser.uid,
                        carId: selectedCar.id,
                        carName: selectedCar.name,
                        startDate: firebase.firestore.Timestamp.fromDate(startDate),
                        endDate: firebase.firestore.Timestamp.fromDate(endDate),
                        totalDays: daysDiff,
                        totalPrice: totalPrice,
                        paymentMethod: paymentMethodSelect.value,
                        paymentStatus: paymentMethodSelect.value === 'onhand' ? 'pending' : 'paid',
                        status: 'pending',
                        adminStatus: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    // Add proof of payment as base64 if available
                    if (proofOfPaymentBase64) {
                        reservationData.proofOfPaymentBase64 = proofOfPaymentBase64;
                        reservationData.hasProofOfPayment = true;
                    }

                    await db.collection('reservations').add(reservationData);
                    
                    // Show success message
                    toastMessage.textContent = `Reservation successful! Your booking for ${selectedCar.name} has been added.`;
                    toast.classList.add('active');
                    
                    // Close popup after delay
                    setTimeout(() => {
                        closePopup();
                        setTimeout(() => {
                            toast.classList.remove('active');
                        }, 3000);
                    }, 1500);
                    
                } catch (error) {
                    console.error('Error saving reservation:', error);
                    alert('Failed to save reservation. Please try again.');
                }
            });
            
            // Image conversion functions - ADDED FROM BROWSE CARS
            function convertImageToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        // Resize and compress the image before converting to base64
                        compressImage(reader.result, 800, 0.7)
                            .then(compressedBase64 => {
                                resolve(compressedBase64);
                            })
                            .catch(error => {
                                console.error('Error compressing image:', error);
                                // If compression fails, use the original base64
                                resolve(reader.result);
                            });
                    };
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                });
            }

            function compressImage(base64Str, maxWidth = 800, quality = 0.7) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = base64Str;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = maxWidth;
                        const MAX_HEIGHT = MAX_WIDTH * (img.height / img.width);
                        
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_WIDTH) {
                                width *= MAX_WIDTH / height;
                                height = MAX_WIDTH;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to base64 with specified quality
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                });
            }
            
            // Close popup when clicking outside
            popupOverlay.addEventListener('click', function(e) {
                if (e.target === popupOverlay) {
                    closePopup();
                }
            });

            // Logout functionality
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    if (confirm('Are you sure you want to logout?')) {
                        // Unsubscribe from listeners before logging out
                        if (userUnsubscribe) userUnsubscribe();
                        if (carsUnsubscribe) carsUnsubscribe();
                        if (reservationsUnsubscribe) reservationsUnsubscribe();
                        
                        auth.signOut().then(() => {
                            window.location.href = 'login.html';
                        }).catch((error) => {
                            console.error('Logout error:', error);
                        });
                    }
                });
            }

            // Make openReservationPopup function available globally
            window.openReservationPopup = openReservationPopup;
            
            // Clean up listeners when page is unloaded
            window.addEventListener('beforeunload', function() {
                if (userUnsubscribe) userUnsubscribe();
                if (carsUnsubscribe) carsUnsubscribe();
                if (reservationsUnsubscribe) reservationsUnsubscribe();
            });
        });
    </script>
</body>
</html>